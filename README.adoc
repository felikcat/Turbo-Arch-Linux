:experimental:
ifdef::env-github[]
:icons:
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:imagesdir: imgs/

.*Dux* installs Arch Linux catered to my tastes; the primary benefits:
- Has lots of desktop-specific optimizations that ArchInstall and ArchTitus fail to do themselves, the ladder two being optimized for servers instead (Linux defaults).
- Kept simple and programmed in Bash.
- No third-party repos that break the OS, unlike Manjaro.
- Uses tricks to speed up installation compared to alternatives, without causing issues.
- Tunnel-visioned on maintaining a stable OS, such as using Btrfs snapshots automatically.
- systemd services are avoided whenever possible, as they are lower-quality than alternatives.
- What's there is what I use. If it's not, I archive it in my GitHub gists; such is the case for the https://gist.github.com/felikcat/ae4d80bd6af49f336b0bbd3bb15bc469[GNOME installer].

.*In-depth overview of what Dux does and its intentions.*
[%collapsible]
====

[.lead]
Goals:

* Being easy to layer on your own additions to Dux to suit your specific needs, or to fork Dux into a custom spin.

* The built-in ricing is ensured to not cause breakages in future updates for KDE.

* No third-party Pacman (package) repositories are ever used.

* The official Arch Linux ISO is used, as it's a solid foundation that also has an entire team to maintain it.

* Dux doesn't provide its own repositories, so running Dux again is itself the updater. If your Arch Linux installed by Dux is not broken, do not run Dux again.

* A unique take on "ricing" (customization) by avoiding the following:
** Stringing together a bunch of different software by different developers, likely also dealing with conflicting opinions.


[.lead]
Actions taken by Dux:

* Useful functionality and customization are present in GUIs.
- Prevents resorting to manpages/manuals and configuration files, instead of trying out changes in a concise environment; example: KDE's System Settings.

* Wary of scope creep, the complexity of Dux's code, and the complexity of what Dux has installed.
- This makes it easy for someone to fork Dux and turn it into what they desire out of Arch Linux.

* Single-user only
- Linux is not meant as a multi-seat system. Projects such as systemd-homed are disabled or excluded from Dux to avoid their inherent security risks and additional complexity.

* Virtual machine guest support
** QEMU (multiple GPU drivers, such as QXL and Virtio), VMWare, Hyper-V, and VirtualBox.

* Support for old to new NVIDIA and Intel GPUs.
** Offloading tasks to a different GPU is also supported.

* Inter fonts by default
** Similar to macOS SF Pro fonts, but optimized for Linux. Great font rendering for low-DPI to high-DPI displays; increased readability and beautiful instead of (poorly) utilitarian.

* `LUKS2`
** Disk encryption to act as an anti-theft measure with minimal performance reduction.

* Swap partition that's the same size as total RAM
** Under high memory pressure situations this keeps Linux afloat in terms of performance; video games run smoother while this is happening.
** Adds support for hibernation to disk, everything is kept as it were before hitting the hibernate button, allowing you to resume your work at a later date with 0 power usage until removed from hibernation.

* `Gamemode`
** Allows for a process to temporarily disable power-saving features for extra performance, mainly used by Lutris for video games.

* `BBRv2`: A TCP congestion control for lower bufferbloat; read about its positive effects on download/upload speeds and latency link:https://archive.ph/l0zc8[here].
** NOTE: qdisc is left at default, rather than the CAKE qdisc being used: +
https://github.com/systemd/systemd/issues/9725#issuecomment-564872011

* `Btrfs` is used to:
** Compress data in real-time without noticeable performance impacts, reducing write amplification (increases longevity of disks by lowering disk usage), and increasing read speeds on slow disks.
** Have high-performance and deduplicated "snapshots" (backups) of key areas, which turns Arch Linux updates breaking software into a small nuisance, as it's very quick and easy to restore to a previous snapshot.
** Allow for an easier data recovery if a disk gets damaged and/or starts to have bad sectors.
** To once a month automatically check (Scrub) over all filesystem data and metadata and verifying the checksums, repairing damage if present and possible.

* `Snapper` instead of `Timeshift`
** `Timeshift` is limited to taking snapshots of @ (root) and @home only.
*** Taking snapshots encompassing all of @ (root) is wasteful; Dux specifically makes Btrfs subvolumes for these directories to exclude them from snapshots: `/srv, /var/cache/pacman/pkg, /var/log, /home`
** `Snapper` makes read-only and replicable snapshots.

* `GPT`
** Compared to MBR, GPT supports disks above 2TB capacity, 128 primary partitions instead of 4, and protects against boot record corruption.

* `I/O scheduling changes`
** `mq-deadline` for SSDs and eMMCs (flash/USB disks/SD cards), `bfq` for spinning disks (HDDs). +
This makes these types of disks highly responsive to your inputs.

* `irqbalance`
** Manages IRQ interrupts more efficiently by being more aware of the current environment. One example is offloading IRQ interrupts to CPU affinities which have the lowest load on them. Another example is respecting VMs having their CPU affinities isolated, meaning irqbalance will offload the IRQ interrupts to CPU affinities that aren't isolated.

* `Flatpak`
** Visual inconsistencies with Flatpaks are mostly fixed.

* `thermald`
** Provides a large performance boost for some Intel laptops, with no observable downsides for other hardware combinations.
** https://www.phoronix.com/scan.php?page=article&item=intel-thermald-tgl&num=2

* Disabled `Baloo` "full-text" indexer
** It's preferred to load files on demand then cache their thumbnails; a simpler approach that works reliably and without performance issues.
** `Baloo` has a link:https://bugs.kde.org/show_bug.cgi?id=402154[long-standing bug] related to usage of Btrfs subvolumes (which we use), that greatly impacts disk usage and overall system performance.
*** Even without this bug, file indexers daemons like `Baloo` won't be used as their design is conceptually over-complicated, and will always be problematic.

* No `systemd-oomd` and no `earlyoom`
** Let the Linux kernel handle OOM (out of memory) situations, it's responsive enough since Linux kernel v6.1 added MGLRU.

* `dnsmasq` and `openresolv`, instead of `systemd-resolved` and `systemd-resolvconf`
** To support "network locking" on some VPN clients, and for more reliable DNS resolution.

* `nftables`
** https://firewalld.org/2018/07/nftables-backend

* `NetworkManager` set to the `iwd` Wi-Fi backend for more network stability and performance.

* `dbus-broker`
** Replaces `dbus-daemon` for the system bus, as it's faster and more stable by being fully adapted for Linux only instead of trying to stay cross-platform.

* `chrony`
** High accuracy time sync that happens to be power efficient. Benchmarks and feature comparisons: https://chrony.tuxfamily.org/comparison.html
** Also accounts for https://en.wikipedia.org/wiki/Leap_second[leap seconds] for additional system clock (time) accuracy. Its "leap smear" mode is used to avoid negative effects from jumping the system clock a sudden and large amount.

* No graphical front-end for the "pacman" package manager
** Do you on Windows, go onto the Microsoft Store to look through and pick out programs you never tried thinking you want to use that program? Likely not, you instead use a search engine to find the program you already knew you wanted, read through its homepage, then install it. +
Search engines are better for finding the programs you need, instead of browsing through a shopping gallery (Windows Store) hoping to find another cool program to install that might be useful. +
Every program installed is another developer or set of developers to trust; keep your program list minimal to keep your PC happy and to waste less of your personal time.

* *Learning sources used:*
. https://www.kernel.org/doc/Documentation/x86/x86_64/boot-options.txt
. https://www.intel.com/content/www/us/en/developer/articles/technical/optimizing-computer-applications-for-latency-part-1-configuring-the-hardware.html
. http://developer.amd.com/wp-content/resources/56263-Performance-Tuning-Guidelines-PUB.pdf

====

== Requirements
. An Intel or AMD CPU newer than 2005.
. *1.5GB* of RAM; 4GB recommended.
. *16GB* of disk space; *128GB* recommended.
- If you have *16GB* of RAM, add on *16GB* more to this requirement, same applies to *32GB* of RAM for *32GB* of disk space.
. *UEFI* must be enabled.
** If booting into the Arch Linux ISO fails on UEFI, a very rare IA32 UEFI BIOS is used. Follow link:https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface#Booting_64-bit_kernel_on_32-bit_UEFI[these instructions] to successfully boot the Arch Linux ISO.
. link:https://archive.is/QwLMB[Disable UEFI Secure Boot]
** If convincing is needed, link:https://github.com/pbatard/rufus/wiki/FAQ#Why_do_I_need_to_disable_Secure_Boot_to_use_UEFINTFS[read this].

NOTE: Dual-booting is supported, given Windows is on a different disk (hard drive) than Arch Linux.



== 1. Verify ISO authenticity

.Download the latest link:https://archlinux.org/download/[Arch Linux ISO]; if you have no torrent client, use link:https://www.qbittorrent.org/download.php[qBittorrent].
- Keep that tab open.

=== macOS
. Install Homebrew from https://brew.sh/
. `brew install gnupg`
. Follow the Linux instructions below.

=== *Windows*
. Install https://gpg4win.org/thanks-for-download.html[GnuPG] using its latest simple installer: +
image:GPG/firefox_4EiWmbJfJo.png[480,360]
. Open a Terminal or PowerShell in the directory of `gpg.exe`: +
image:GPG/explorer_sIHtC1HEcI.png[480,360]
. Follow the Linux instructions below.

=== Linux
. NOTE: The full key (not short or long) is used to fully protect against collision attacks. +
`gpg --auto-key-locate clear,wkd -v --locate-external-key pierre@archlinux.org`

. Download the "ISO PGP signature" from https://archlinux.org/download/[here].

. `gpg --full-gen-key`
```
Please select what kind of key you want:
   (1) RSA and RSA
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
   (9) ECC (sign and encrypt) *default*
  (10) ECC (sign only)
  (14) Existing key from card
Your selection? ↵

Please select which elliptic curve you want:
   (1) Curve 25519 *default*
   (4) NIST P-384
   (6) Brainpool P-256
Your selection? ↵

Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0) ↵
Key does not expire at all
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: dux
Email address: dux@dux.com
Comment:
You selected this USER-ID:
    "dux <dux@dux.com>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
```

. After your new GPG key has been generated, show its full key; [ultimate] indicates that you trust this key ultimately (you created the key), which is the desired behavior. +
`gpg --list-secret-keys --keyid-format none`

. Sign Arch's GPG key with yours. +
`gpg --sign-key 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C`

. Verify if the ISO is authentic, and its file integrity doesn't fail (indicates a broken download). +
`gpg --verify /path/to/archkbd:[TAB].sig`

- image:GPG/WindowsTerminal_RNqnz5MWaf.png[480,360]


== 2. Format a USB with the Arch Linux ISO
WARNING: This will destroy all previous data on the targeted device!

=== Windows
. Download and install rufus-$version.exe +
https://github.com/pbatard/rufus/releases
. Add the Arch ISO then copy the following settings: +
image:rufus-4.2_NDydafPQE3.png[480,360]

. Click Start, then use "Write in ISO -> ESP mode".

=== macOS and Linux
Use https://github.com/balena-io/etcher/releases[balenaEtcher].

.dd method (not recommended)
[%collapsible]
====
. Thoroughly list disks and partitions; to see what disk/drive you are going to format. +
`$ lsblk -o PATH,MODEL,PARTLABEL,FSTYPE,FSVER,SIZE,FSUSE%,FSAVAIL,MOUNTPOINTS`

. Do not append numbers to the end of /dev/EXAMPLE +
`# dd if=/path/to/archkbd:[TAB] of=/dev/EXAMPLE bs=8M oflag=direct status=progress`
====

=== OpenBSD
. List all available disks: +
`$ dmesg|egrep '^([cswf]d). '` or `$ df -h`

. List the partitions of a disk, and show sizes in gigabytes (-p g): +
`# disklabel -p g EXAMPLE`

. Do not append numbers to the end of /dev/EXAMPLE: +
`# dd bs=4M if=/path/to/archkbd:[TAB] of=/dev/EXAMPLE conv=sync`


== Starting the Dux installer

Once booted into the Arch Linux ISO, ensure an internet connection is established. +
`$ ping archlinux.org`

.No connection?
[%collapsible]
====

*For Wi-Fi:*

. Run `# rfkill unblock all`
. `# connmanctl`
- `technologies`
- `enable wifi`
- `services`
- `agent on`
- `station wlan0 connect your_wifi_SSID`
- `exit`

TIP: If "wlan0" is not the correct interface, use iwctl's `station list` to see your wireless interface(s).

*https://wiki.archlinux.org/title/Mmcli[For mobile modems]*.

====

. Login with:
- Username: `root`
- Password: `artix`

. `# pacman-key --init`

. `# pacman -Syy git gptfdisk parted`

. `# git clone --depth=1 -b r1 https://github.com/felikcat/dux`

. Open `~/dux/configs/settings.sh` in your editor of choice, likely `vim` or `nano`
** Do not remove options in Dux's configs! Disable them.

. `# bash ~/dux/scripts/format_disk.sh`
** kbd:[Ctrl] + kbd:[C] to exit the disk formatter if you're not comfortable proceeding.

. `# bash ~/dux/scripts/install_dux.sh`
** If there's issues: run with `DEBUG=1` (put before `bash`) for more verbose logs.

___

.After the reboot:
* Connect to your Wi-Fi network again if needed.
* Open "Konsole".
. `$ bash ~/dux/scripts/05-booted.sh`
- During this script, your account password will be asked for.

. Configure `~/dux/configs/software_catalog.sh` with a text editor of your choice.
** After done configuring, run: +
`# sudo bash ~/dux/scripts/software_catalog.sh`

___
*If you have issues, please read => link:potential_fixes.adoc[potential_fixes.adoc]*

== How to help Dux out
- Star this respository so more people see it, or other forms of publicity like YouTube videos.
- Make an account on the Arch Linux user repository, and "Vote for this package" for the following:
. https://aur.archlinux.org/packages/refind-btrfs
. https://aur.archlinux.org/packages/btrfs-assistant
